<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Ahayoo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Game / Coding / Design / Life">
<meta property="og:type" content="website">
<meta property="og:title" content="Ahayoo">
<meta property="og:url" content="https://www.ahayoo.com/index.html">
<meta property="og:site_name" content="Ahayoo">
<meta property="og:description" content="Game / Coding / Design / Life">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ahayoo">
<meta name="twitter:description" content="Game / Coding / Design / Life">
  
    <link rel="alternate" href="/atom.xml" title="Ahayoo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Ahayoo</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Aha your soul</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://www.ahayoo.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Flutter-FutureBuilder" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/09/Flutter-FutureBuilder/" class="article-date">
  <time datetime="2019-05-09T00:38:53.000Z" itemprop="datePublished">2019-05-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/09/Flutter-FutureBuilder/">Flutter-FutureBuilder</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在看image-picker的<a href="https://github.com/flutter/plugins/blob/master/packages/image_picker/example/lib/main.dart" target="_blank" rel="external">sample</a>的时候，看到了FutureBuilder这个类，于是简单研究了一下</p>
<h2 id="Future-Builder"><a href="#Future-Builder" class="headerlink" title="Future Builder"></a>Future Builder</h2><p>doc：<a href="https://docs.flutter.io/flutter/widgets/FutureBuilder-class.html" target="_blank" rel="external">click me</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">FutureBuilder&lt;String&gt;(</div><div class="line">  future: _calculation, // a previously-obtained Future&lt;String&gt; or null</div><div class="line">  builder: (BuildContext context, AsyncSnapshot&lt;String&gt; snapshot) &#123;</div><div class="line">    switch (snapshot.connectionState) &#123;</div><div class="line">      case ConnectionState.none:</div><div class="line">        return Text(&apos;Press button to start.&apos;);</div><div class="line">      case ConnectionState.active:</div><div class="line">      case ConnectionState.waiting:</div><div class="line">        return Text(&apos;Awaiting result...&apos;);</div><div class="line">      case ConnectionState.done:</div><div class="line">        if (snapshot.hasError)</div><div class="line">          return Text(&apos;Error: $&#123;snapshot.error&#125;&apos;);</div><div class="line">        return Text(&apos;Result: $&#123;snapshot.data&#125;&apos;);</div><div class="line">    &#125;</div><div class="line">    return null; // unreachable</div><div class="line">  &#125;,</div><div class="line">)</div></pre></td></tr></table></figure>
<p>简单来说，FutureBuilder本身是一个widget，根据future的不同状态，来重绘widget。</p>
<p>看一下FutureBuilder的源码，也很简单，为了节省篇幅，删掉了源码中的注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">class FutureBuilder&lt;T&gt; extends StatefulWidget &#123;</div><div class="line">  const FutureBuilder(&#123;</div><div class="line">    Key key,</div><div class="line">    this.future,</div><div class="line">    this.initialData,</div><div class="line">    @required this.builder,</div><div class="line">  &#125;) : assert(builder != null),</div><div class="line">       super(key: key);</div><div class="line"></div><div class="line">  final Future&lt;T&gt; future;</div><div class="line">  final AsyncWidgetBuilder&lt;T&gt; builder;</div><div class="line">  final T initialData;</div><div class="line"></div><div class="line">  @override</div><div class="line">  State&lt;FutureBuilder&lt;T&gt;&gt; createState() =&gt; _FutureBuilderState&lt;T&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line">class _FutureBuilderState&lt;T&gt; extends State&lt;FutureBuilder&lt;T&gt;&gt; &#123;</div><div class="line">  Object _activeCallbackIdentity;</div><div class="line">  AsyncSnapshot&lt;T&gt; _snapshot;</div><div class="line"></div><div class="line">  @override</div><div class="line">  void initState() &#123;</div><div class="line">    super.initState();</div><div class="line">    _snapshot = AsyncSnapshot&lt;T&gt;.withData(ConnectionState.none, widget.initialData);</div><div class="line">    _subscribe();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @override</div><div class="line">  void didUpdateWidget(FutureBuilder&lt;T&gt; oldWidget) &#123;</div><div class="line">    super.didUpdateWidget(oldWidget);</div><div class="line">    if (oldWidget.future != widget.future) &#123;</div><div class="line">      if (_activeCallbackIdentity != null) &#123;</div><div class="line">        _unsubscribe();</div><div class="line">        _snapshot = _snapshot.inState(ConnectionState.none);</div><div class="line">      &#125;</div><div class="line">      _subscribe();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @override</div><div class="line">  Widget build(BuildContext context) =&gt; widget.builder(context, _snapshot);</div><div class="line"></div><div class="line">  @override</div><div class="line">  void dispose() &#123;</div><div class="line">    _unsubscribe();</div><div class="line">    super.dispose();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  void _subscribe() &#123;</div><div class="line">    if (widget.future != null) &#123;</div><div class="line">      final Object callbackIdentity = Object();</div><div class="line">      _activeCallbackIdentity = callbackIdentity;</div><div class="line">      widget.future.then&lt;void&gt;((T data) &#123;</div><div class="line">        if (_activeCallbackIdentity == callbackIdentity) &#123;</div><div class="line">          setState(() &#123;</div><div class="line">            _snapshot = AsyncSnapshot&lt;T&gt;.withData(ConnectionState.done, data);</div><div class="line">          &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125;, onError: (Object error) &#123;</div><div class="line">        if (_activeCallbackIdentity == callbackIdentity) &#123;</div><div class="line">          setState(() &#123;</div><div class="line">            _snapshot = AsyncSnapshot&lt;T&gt;.withError(ConnectionState.done, error);</div><div class="line">          &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">      _snapshot = _snapshot.inState(ConnectionState.waiting);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  void _unsubscribe() &#123;</div><div class="line">    _activeCallbackIdentity = null;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建的时候可以传入对应请求数据的future，用来真正创建widget的builder，同时可以传入一个泛型的initialData。<br>真正执行build的时候，是委托传入的这个builder来执行控件的创建。这个builder是一个AsyncWidgetBuilder类型，通过处理futureBuilder提供的AsyncSnapshot，来获取必要的状态和数据。<br>在initState的时候，执行_subscribe，来启动对应的future，在future正常执行完或者出错之后，通过setState先将snapshot设置为指定的状态，然后传递给真正的builder函数来把控件创建出来<br>特别要说明的是callbackIdentity这个对象，执行subscribe的时候，会new一个空object出来，说白了就是给future设置了一个uuid。当发生了future变化的时候，一是用来清理掉原来的future，二是原来future返回回来的时候，因为本身future变了，所以跳过原来的setState，以免错误更新界面</p>
<h2 id="ImagePicker-的-sample"><a href="#ImagePicker-的-sample" class="headerlink" title="ImagePicker 的 sample"></a>ImagePicker 的 sample</h2><p>回到image_picker对应<a href="(https://github.com/flutter/plugins/blob/master/packages/image_picker/example/lib/main.dart">sample</a>)的代码，先看state的build部分：</p>
<ul>
<li>中央部分是图片预览（_previewImage）或者是视频预览的控件（_previewVideo），其中video控件还要附带上VideoPlayerController这个类</li>
<li>根据平台判断是Android还是iOS，如果是iOS的话，直接显示预览控件，如果是Android的话，使用FutureBuilder，去等待一个retrieveLostData的Future。因为Android平台有Activity被回收的情况，需要使用ImagePicker.retrieveLostData()来复原丢失的数据。相关可以参考这个函数以及LostDataResponse这个类</li>
<li>底部四个FloatingActionButton，调用了_onImageButtonPressed，最终调用ImagePicker的pickVideo或者pickImage，通过source来区分是ImageSource.gallery或者ImageSource.camera。获取到对应的file之后，再继续进行video或者image的显示。</li>
</ul>
<p>// TODO image_picker的源码分析</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ahayoo.com/2019/05/09/Flutter-FutureBuilder/" data-id="cjvhe4j6j001bbgd58fe0hbtz" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Jenkins读取Properties文件时的编码问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/07/Jenkins读取Properties文件时的编码问题/" class="article-date">
  <time datetime="2019-03-07T03:06:11.000Z" itemprop="datePublished">2019-03-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/07/Jenkins读取Properties文件时的编码问题/">Jenkins读取Properties文件时的编码问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在编写Jenkinsfile的时候，如果使用readProperties直接读取一个含有中文的properties文件，那么在日志中输出的是乱码。<br>找了一个比较简单的解决方案：<br>1）首先使用<code>readFile(file: &quot;the/path&quot;, encoding: &quot;UTF-8&quot;)</code>来读取fileData，<br>2）然后使用<code>readProperties(text: fileData)</code>的方式来读取properties文件，这样就可以正常显示了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ahayoo.com/2019/03/07/Jenkins读取Properties文件时的编码问题/" data-id="cjvhe4j6d0014bgd5x0omdg0a" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jenkins/">Jenkins</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-CertificatePinner与Charles抓包的问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/22/CertificatePinner与Charles抓包的问题/" class="article-date">
  <time datetime="2018-02-22T05:32:14.000Z" itemprop="datePublished">2018-02-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/22/CertificatePinner与Charles抓包的问题/">证书固定、CertificatePinner与Charles抓包的问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="证书固定"><a href="#证书固定" class="headerlink" title="证书固定"></a>证书固定</h2><p>前段时间为我们的代码中增加了证书固定的代码，用来防止APP的网络请求被抓包。</p>
<p>方法如下：<br>1、使用openssl，获取我们自己CA证书的公钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl s_client -connect mydomain.com:443 -servername mydomain.com | openssl x509 -pubkey -noout | openssl rsa -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64</div></pre></td></tr></table></figure>
<p>2、因为网络库使用的OkHttp+Retrofit，所以代码中增加了如下内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CA_DOMAIN = <span class="string">"*.mydomain.com"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CA_PUBLIC_KEY = <span class="string">"sha256/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>;</div><div class="line"></div><div class="line">   .....</div><div class="line"></div><div class="line">   CertificatePinner pinner = <span class="keyword">new</span> CertificatePinner.Builder()</div><div class="line">               .add(CA_DOMAIN, CA_PUBLIC_KEY)</div><div class="line">               .build();</div><div class="line"></div><div class="line">   .....</div><div class="line">   </div><div class="line">   OkHttpClient.Builder clientBuilder = <span class="keyword">new</span> OkHttpClient.Builder()</div><div class="line">           .certificatePinner(pinner);</div></pre></td></tr></table></figure>
<p>这样，就可以一定程度上保护我们的代码不被抓包。</p>
<h2 id="抓包调试"><a href="#抓包调试" class="headerlink" title="抓包调试"></a>抓包调试</h2><p>随之而来的又是另外一个问题，在使用证书固定的同时，我们自己也将无法对我们的代码抓包来进行调试，本来想通过开一些特殊的口子来关闭CertificatePinner，进而来绕过我们自己的限制，但是这样会增加风险。</p>
<p>那该怎么办呢？</p>
<p>其实只要在原本证书之外，再多信任一个我们自己内部使用的Charles的证书就可以了。</p>
<p>方法如下：</p>
<p>（我们使用的Charles版本是v4.0）</p>
<p>1、Charles菜单中选择Help &gt; SSLProxying &gt; View Generated SSL Certificates Keystore Password，将显示的密码记下来。这个是在每个Charles安装的时候自动生成的，和你本机的Charles Root Certificates相对应。</p>
<p>2、Charles菜单中选择Help &gt; SSLProxying &gt; Export Charles Root Certificate and Private Key…，然后输入刚才的密码，将生成的p12文件保存好。</p>
<p>3、Charles菜单中选择Help &gt; SSLProxying &gt; Save Charles Root Certificate…，将pem文件保存下来</p>
<p>4、使用openssl，从刚才的pem文件中获取公钥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl x509 -pubkey -noout -in charles-ssl-proxying-certificate.pem  | openssl rsa -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64</div></pre></td></tr></table></figure>
<p>5、依照上面证书固定的代码，增加一个PUBLIC_KEY</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">CertificatePinner pinner = <span class="keyword">new</span> CertificatePinner.Builder()</div><div class="line">            .add(CA_DOMAIN, CA_PUBLIC_KEY)</div><div class="line">            .add(CA_DOMAIN, CA_PUBLIC_KEY_2)</div><div class="line">            .build();</div></pre></td></tr></table></figure>
<p>6、将刚才的pem文件安装到手机上，一般在 系统设置 &gt; 安全 的菜单中，从SD卡安装刚才的pem文件，并且配置好抓包的代理。（这个和一般的Charles抓包配置一样）</p>
<p>7、（在需要抓包的电脑上）Charles菜单中选择proxy &gt; SSL Proxy Settings…，选择Root Certificate，然后选择Choose，选择之前保存的p12文件，这个时候会让你输入之前的密码。</p>
<p>8、（在需要抓包的电脑上）重启Charles</p>
<p>这样就完成了所有的配置，之后只要保存好对应的p12文件（包含私钥公钥）、pem文件（包含公钥）和密码，就可以让需要调试的小伙伴来进行抓包了。</p>
<h2 id="关于Android7-0"><a href="#关于Android7-0" class="headerlink" title="关于Android7.0+"></a>关于Android7.0+</h2><p>Android7.0及以上除了要完成上述的操作以外，还需要额外的在代码中进行网络安全性配置，这里就不多说了，官网上都有，很详细。可以看这里：<a href="https://developer.android.com/training/articles/security-config.html?hl=zh-cn#CustomTrust" target="_blank" rel="external">https://developer.android.com/training/articles/security-config.html?hl=zh-cn#CustomTrust</a></p>
<p>注意，charles的那个pem，以及原本api请求所需要的pem都要放到raw里面</p>
<p>可以使用下面的命令获取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl s_client -connect mydomain.com:443 -servername mydomain.com | openssl x509 -out test.pem</div></pre></td></tr></table></figure>
<p>如果进行了网络安全性配置，那么之前第6步中，pem后缀的那个CA证书，就不用手动安装到手机上了（因为apk中自带了）</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://developer.android.com/training/articles/security-config.html?hl=zh-cn#CustomTrust" target="_blank" rel="external">https://developer.android.com/training/articles/security-config.html?hl=zh-cn#CustomTrust</a><br><a href="https://www.cnblogs.com/eshizhan/archive/2012/10/07/2713557.html" target="_blank" rel="external">https://www.cnblogs.com/eshizhan/archive/2012/10/07/2713557.html</a><br><a href="http://www.cnblogs.com/guogangj/p/4118605.html" target="_blank" rel="external">http://www.cnblogs.com/guogangj/p/4118605.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ahayoo.com/2018/02/22/CertificatePinner与Charles抓包的问题/" data-id="cjvhe4j6i0019bgd5fbqpldld" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GML迷之问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/13/GML迷之问题/" class="article-date">
  <time datetime="2018-02-13T03:01:00.000Z" itemprop="datePublished">2018-02-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GMS2/">GMS2</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/13/GML迷之问题/">GML迷之问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近一直在做GMS2的GUI研究，发现一个很诡异的问题</p>
<p>在退出整个程序的时候，如果在某些对象的CleanUp中调用了show_debug_message，会导致退出的时候崩溃。虽然不知道是什么原因，但是只要将这行代码去掉，就不再崩溃了。</p>
<p>怀疑是底层哪里有bug，但是靠上层代码是没法修复的了。</p>
<p>记录在这里，也许之后的Runtime更新会修复这个问题。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ahayoo.com/2018/02/13/GML迷之问题/" data-id="cjvhe4j6h0016bgd5g6m58z6a" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-LiveData和ViewModel" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/08/LiveData和ViewModel/" class="article-date">
  <time datetime="2018-01-08T08:19:00.000Z" itemprop="datePublished">2018-01-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/08/LiveData和ViewModel/">Android架构组件（二）——ViewModel和LiveData</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>主要来源：</p>
<p><a href="https://developer.android.com/topic/libraries/architecture/livedata.html" target="_blank" rel="external">https://developer.android.com/topic/libraries/architecture/livedata.html</a></p>
<p><a href="https://developer.android.com/topic/libraries/architecture/viewmodel.html" target="_blank" rel="external">https://developer.android.com/topic/libraries/architecture/viewmodel.html</a></p>
<h2 id="Why-View-Model"><a href="#Why-View-Model" class="headerlink" title="Why View Model"></a>Why View Model</h2><p>1）Android Framework 处理各种组件的声明周期，会在某些时候决定销毁并且重建UI组件（activity、fragment）。在这个时候，很多界面上的数据就丢失了。<br>虽然可以使用onSaveInstanceState来做数据保存和恢复，但是这个只适合小规模的数据，不适合大量的数据需要序列化和反序列化的情况。</p>
<p>2）很多时候我们需要异步请求数据，但是返回的时候如果UI组件（activity，fragment）已经被销毁和重建（比如转屏），我们又要去重新请求，这个是一种资源的浪费</p>
<p>3）从UI组件（activity，fragment）中分离数据层的逻辑</p>
<h2 id="Why-Live-Data"><a href="#Why-Live-Data" class="headerlink" title="Why Live Data"></a>Why Live Data</h2><p>LiveData是一个数据观察者，同时会和App中组件的声明周期进行绑定。当生命周期处于STARTED或者RESUMED的时候，会响应数据的变化</p>
<ul>
<li>保证UI和数据状态一致</li>
<li>没有内存泄露</li>
<li>当停止activity的时候，不会crash</li>
<li>不需要手动处理声明周期</li>
<li>自动处理configuration change（比如转屏）</li>
<li>共享资源（LiveData -&gt; Service，需要数据的直接观察这个LiveData即可）</li>
</ul>
<h2 id="Use-View-Model-amp-Live-Data"><a href="#Use-View-Model-amp-Live-Data" class="headerlink" title="Use View Model &amp; Live Data"></a>Use View Model &amp; Live Data</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//////////  基本使用  //////////</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> MutableLiveData&lt;List&lt;User&gt;&gt; users;</div><div class="line">    <span class="keyword">public</span> LiveData&lt;List&lt;User&gt;&gt; getUsers() &#123;</div><div class="line">        <span class="keyword">if</span> (users == <span class="keyword">null</span>) &#123;</div><div class="line">            users = <span class="keyword">new</span> MutableLiveData&lt;List&lt;Users&gt;&gt;();</div><div class="line">            loadUsers();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> users;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadUsers</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Do an asyncronous operation to fetch users.</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="comment">// Create a ViewModel the first time the system calls an activity's onCreate() method.</span></div><div class="line">        <span class="comment">// Re-created activities receive the same MyViewModel instance created by the first activity.</span></div><div class="line"></div><div class="line">        MyViewModel model = ViewModelProviders.of(<span class="keyword">this</span>).get(MyViewModel.class);</div><div class="line">        model.getUsers().observe(<span class="keyword">this</span>, users -&gt; &#123;</div><div class="line">            <span class="comment">// update UI</span></div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//////////  Fragment之间共享数据 //////////</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SharedViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MutableLiveData&lt;Item&gt; selected = <span class="keyword">new</span> MutableLiveData&lt;Item&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">(Item item)</span> </span>&#123;</div><div class="line">        selected.setValue(item);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> LiveData&lt;Item&gt; <span class="title">getSelected</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> selected;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> SharedViewModel model;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        model = ViewModelProviders.of(getActivity()).get(SharedViewModel.class);</div><div class="line">        itemSelector.setOnClickListener(item -&gt; &#123;</div><div class="line">            model.select(item);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DetailFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        SharedViewModel model = ViewModelProviders.of(getActivity()).get(SharedViewModel.class);</div><div class="line">        model.getSelected().observe(<span class="keyword">this</span>, &#123; item -&gt;</div><div class="line">           <span class="comment">// Update the UI.</span></div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="/images/viewmodel-lifecycle.png" alt="Image"></p>
<p><img src="/images/viewmodel-loader.png" alt="Image"></p>
<p><img src="/images/viewmodel-replace-loader.png" alt="Image"></p>
<h2 id="Advanced-Usage"><a href="#Advanced-Usage" class="headerlink" title="Advanced Usage"></a>Advanced Usage</h2><h3 id="使用MutableLiveData"><a href="#使用MutableLiveData" class="headerlink" title="使用MutableLiveData"></a>使用MutableLiveData</h3><p>LiveData中的实际数据mData，外部只能通过getValue来获取。如果想要从外部设置，需要使用MutableLiveData，这个类会包含额外的两个方法setValue()和postValue()，前一个在主线程中设置数据，后一个在非主线程中设置数据。</p>
<h3 id="扩展-LiveData"><a href="#扩展-LiveData" class="headerlink" title="扩展 LiveData"></a>扩展 LiveData</h3> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//////////  响应生命周期的变化 //////////</span></div><div class="line"></div><div class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StockLiveData</span> <span class="keyword">extends</span> <span class="title">LiveData</span>&lt;<span class="title">BigDecimal</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> StockManager mStockManager;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> SimplePriceListener mListener = <span class="keyword">new</span> SimplePriceListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPriceChanged</span><span class="params">(BigDecimal price)</span> </span>&#123;</div><div class="line">            setValue(price);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StockLiveData</span><span class="params">(String symbol)</span> </span>&#123;</div><div class="line">        mStockManager = <span class="keyword">new</span> StockManager(symbol);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActive</span><span class="params">()</span> </span>&#123;</div><div class="line">        mStockManager.requestPriceUpdates(mListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onInactive</span><span class="params">()</span> </span>&#123;</div><div class="line">        mStockManager.removeUpdates(mListener);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//////////  共享数据  //////////</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StockLiveData</span> <span class="keyword">extends</span> <span class="title">LiveData</span>&lt;<span class="title">BigDecimal</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> StockLiveData sInstance;</div><div class="line">    <span class="keyword">private</span> StockManager mStockManager;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> SimplePriceListener mListener = <span class="keyword">new</span> SimplePriceListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPriceChanged</span><span class="params">(BigDecimal price)</span> </span>&#123;</div><div class="line">            setValue(price);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StockLiveData <span class="title">get</span><span class="params">(String symbol)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">            sInstance = <span class="keyword">new</span> StockLiveData(symbol);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sInstance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">StockLiveData</span><span class="params">(String symbol)</span> </span>&#123;</div><div class="line">        mStockManager = <span class="keyword">new</span> StockManager(symbol);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActive</span><span class="params">()</span> </span>&#123;</div><div class="line">        mStockManager.requestPriceUpdates(mListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onInactive</span><span class="params">()</span> </span>&#123;</div><div class="line">        mStockManager.removeUpdates(mListener);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h3><p><a href="https://developer.android.com/reference/android/arch/lifecycle/Transformations.html" target="_blank" rel="external">https://developer.android.com/reference/android/arch/lifecycle/Transformations.html</a></p>
<h3 id="Merge-Multiple-Live-Data"><a href="#Merge-Multiple-Live-Data" class="headerlink" title="Merge Multiple Live Data"></a>Merge Multiple Live Data</h3><p><a href="https://developer.android.com/reference/android/arch/lifecycle/MediatorLiveData.html" target="_blank" rel="external">https://developer.android.com/reference/android/arch/lifecycle/MediatorLiveData.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ahayoo.com/2018/01/08/LiveData和ViewModel/" data-id="cjvhe4j6a0010bgd5f4w6ncif" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-初探RoomPersistenceLibrary" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/27/初探RoomPersistenceLibrary/" class="article-date">
  <time datetime="2017-11-27T08:32:30.000Z" itemprop="datePublished">2017-11-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/27/初探RoomPersistenceLibrary/">Android架构组件——初探Room Persistence Library</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>谷歌前段时间推出了Android Architecture Components的1.0.0正式版，为App的架构提供了一些官方功能，运用这些工具，我们可以搭建更加灵活和健壮的APP架构。今天要说的就是这个组件之一，Room Persistence Library</p>
<h2 id="什么是Room"><a href="#什么是Room" class="headerlink" title="什么是Room"></a>什么是Room</h2><p>官方链接：<a href="https://developer.android.com/topic/libraries/architecture/room.html" target="_blank" rel="external">link</a></p>
<blockquote>
<p>The Room persistence library provides an abstraction layer over SQLite to allow fluent database access while harnessing the full power of SQLite.</p>
</blockquote>
<p>这是在SQLite上的一层抽象封装，让你可以更加无障碍的使用SQLite数据库</p>
<h2 id="如何使用Room"><a href="#如何使用Room" class="headerlink" title="如何使用Room"></a>如何使用Room</h2><h3 id="接入"><a href="#接入" class="headerlink" title="接入"></a>接入</h3><p>1、在<code>app</code>的<code>build.gradle</code>中的dependencies里加入以下代码</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">compile (<span class="string">"android.arch.persistence.room:runtime:1.0.0"</span>)</div><div class="line">annotationProcessor (<span class="string">"android.arch.persistence.room:compiler:1.0.0"</span>)</div></pre></td></tr></table></figure>
<p>2、比较诡异的一个事情是，由于我们的APP使用了support包25.4.0版本，而room里面自带了26+的版本，如果直接接入Room，会导致我们使用FragmentActivity时，找不到ActivityCompatApi23这个类。</p>
<p>于是在<code>project</code>的<code>build.gradle</code>中的allprojects下面，增加了强制切换依赖的代码。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">configurations.all &#123;</div><div class="line">    resolutionStrategy.force <span class="string">'com.android.support:support-core-utils:25.4.0'</span></div><div class="line">    resolutionStrategy.force <span class="string">'com.android.support:support-annotations:25.4.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3、这样就完成了接入</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h4 id="1、创建Entity"><a href="#1、创建Entity" class="headerlink" title="1、创建Entity"></a>1、创建Entity</h4><p>创建基本的Entity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Entity</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    <span class="meta">@PrimaryKey</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String firstName;</div><div class="line">    <span class="keyword">public</span> String lastName;</div><div class="line"></div><div class="line">    <span class="meta">@Ignore</span></div><div class="line">    Bitmap picture;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>类</p>
<ul>
<li>如果想使用复合主键，在class上s使用@Entity(primaryKeys = {“firstName”, “lastName”})</li>
<li>数据表默认为class的名字，如果想要替换，在class上使用@Entity(tableName = “users”)（SQLite中的table名字是大小写不敏感的）</li>
</ul>
<p>字段</p>
<ul>
<li>每个字段如果不为public，需要提供getter和setter方法。</li>
<li>如果想要使用自动增长id，在字段上使用@PrimaryKey(autoGenerate = true)</li>
<li>每个列的名字默认为字段的名字，如果需要替换，在字段上使用@ColumnInfo(name = “first_name”)</li>
</ul>
<p>创建索引<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Entity</span>(indices = &#123;<span class="meta">@Index</span>(<span class="string">"name"</span>),</div><div class="line">        <span class="meta">@Index</span>(value = &#123;<span class="string">"last_name"</span>, <span class="string">"address"</span>&#125;)&#125;)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    <span class="meta">@PrimaryKey</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String firstName;</div><div class="line">    <span class="keyword">public</span> String address;</div><div class="line"></div><div class="line">    <span class="meta">@ColumnInfo</span>(name = <span class="string">"last_name"</span>)</div><div class="line">    <span class="keyword">public</span> String lastName;</div><div class="line"></div><div class="line">    <span class="meta">@Ignore</span></div><div class="line">    Bitmap picture;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>保持索引唯一<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Entity</span>(indices = &#123;<span class="meta">@Index</span>(value = &#123;<span class="string">"first_name"</span>, <span class="string">"last_name"</span>&#125;,</div><div class="line">        unique = <span class="keyword">true</span>)&#125;)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    <span class="meta">@PrimaryKey</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id;</div><div class="line"></div><div class="line">    <span class="meta">@ColumnInfo</span>(name = <span class="string">"first_name"</span>)</div><div class="line">    <span class="keyword">public</span> String firstName;</div><div class="line"></div><div class="line">    <span class="meta">@ColumnInfo</span>(name = <span class="string">"last_name"</span>)</div><div class="line">    <span class="keyword">public</span> String lastName;</div><div class="line"></div><div class="line">    <span class="meta">@Ignore</span></div><div class="line">    Bitmap picture;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>外键<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Entity</span>(foreignKeys = <span class="meta">@ForeignKey</span>(entity = User.class,</div><div class="line">                                  parentColumns = <span class="string">"id"</span>,</div><div class="line">                                  childColumns = <span class="string">"user_id"</span>))</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</div><div class="line">    <span class="meta">@PrimaryKey</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> bookId;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String title;</div><div class="line"></div><div class="line">    <span class="meta">@ColumnInfo</span>(name = <span class="string">"user_id"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> userId;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>嵌套对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> String street;</div><div class="line">    <span class="keyword">public</span> String state;</div><div class="line">    <span class="keyword">public</span> String city;</div><div class="line"></div><div class="line">    <span class="meta">@ColumnInfo</span>(name = <span class="string">"post_code"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> postCode;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Entity</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    <span class="meta">@PrimaryKey</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String firstName;</div><div class="line"></div><div class="line">    <span class="meta">@Embedded</span></div><div class="line">    <span class="keyword">public</span> Address address;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="2、创建DAO（Data-Access-Object）"><a href="#2、创建DAO（Data-Access-Object）" class="headerlink" title="2、创建DAO（Data Access Object）"></a>2、创建DAO（Data Access Object）</h4><p>Room不允许在主线程进行操作，除非在创建Database的时候调用allowMainThreadQueries()<br>可以使用LiveData或者Flowable来接收查询的结果</p>
<p>增删改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Dao</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyDao</span> </span>&#123;</div><div class="line">    <span class="meta">@Insert</span>(onConflict = OnConflictStrategy.REPLACE)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertUsers</span><span class="params">(User... users)</span></span>; <span class="comment">// can return long -&gt; row id</span></div><div class="line"></div><div class="line">    <span class="meta">@Insert</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertBothUsers</span><span class="params">(User user1, User user2)</span></span>; <span class="comment">// List&lt;Long&gt; or long[] -&gt; row ids</span></div><div class="line"></div><div class="line">    <span class="meta">@Insert</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertUsersAndFriends</span><span class="params">(User user, List&lt;User&gt; friends)</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Update</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUsers</span><span class="params">(User... users)</span></span>; <span class="comment">// int -&gt; row count</span></div><div class="line"></div><div class="line">    <span class="meta">@Delete</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUsers</span><span class="params">(User... users)</span></span>; <span class="comment">// int -&gt; row count</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除了使用接口之外，还可以使用抽象类来定义DAO，可以带上一个参数为RoomDatabase的构造函数</p>
<p>查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Dao</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyDao</span> </span>&#123;</div><div class="line">    <span class="meta">@Query</span>(<span class="string">"SELECT * FROM user"</span>)</div><div class="line">    <span class="keyword">public</span> User[] loadAllUsers();</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"SELECT * FROM user WHERE age &gt; :minAge"</span>)</div><div class="line">    <span class="keyword">public</span> User[] loadAllUsersOlderThan(<span class="keyword">int</span> minAge);</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"SELECT * FROM user WHERE age BETWEEN :minAge AND :maxAge"</span>)</div><div class="line">    <span class="keyword">public</span> User[] loadAllUsersBetweenAges(<span class="keyword">int</span> minAge, <span class="keyword">int</span> maxAge);</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"SELECT * FROM user WHERE first_name LIKE :search "</span></div><div class="line">           + <span class="string">"OR last_name LIKE :search"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findUserWithName</span><span class="params">(String search)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-创建Database"><a href="#3-创建Database" class="headerlink" title="3. 创建Database"></a>3. 创建Database</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Database</span>(entities = &#123;User.class&#125;, version = <span class="number">1</span>)</div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AppDatabase</span> <span class="keyword">extends</span> <span class="title">RoomDatabase</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> UserDao <span class="title">userDao</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-代码中使用"><a href="#4-代码中使用" class="headerlink" title="4. 代码中使用"></a>4. 代码中使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">AppDatabase db = Room.databaseBuilder(getApplicationContext(),</div><div class="line">        AppDatabase.class, <span class="string">"database-name"</span>).build();</div></pre></td></tr></table></figure>
<h2 id="为什么使用Room"><a href="#为什么使用Room" class="headerlink" title="为什么使用Room"></a>为什么使用Room</h2><h3 id="Room-vs-SQLite"><a href="#Room-vs-SQLite" class="headerlink" title="Room vs SQLite"></a>Room vs SQLite</h3><p>直接使用SQLite会比较复杂<br>Room封装更加简单灵活</p>
<h3 id="Room-vs-Realm"><a href="#Room-vs-Realm" class="headerlink" title="Room vs Realm"></a>Room vs Realm</h3><p>在数据处理速度上，Realm &gt; Room，<br>包体积和方法数，Room 优于 Realm<br>如果不介意写一些SQL查询语句，以及数据处理的规模不是很大，推荐使用Room，更加小巧灵活<br>如果要处理大批量数据，推荐接入Realm</p>
<p>参考：<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2017/0926/8551.html" target="_blank" rel="external">http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2017/0926/8551.html</a></p>
<h2 id="其他内容"><a href="#其他内容" class="headerlink" title="其他内容"></a>其他内容</h2><p>1）数据库版本和数据迁移</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Room.databaseBuilder(getApplicationContext(), MyDb.class, <span class="string">"database-name"</span>)</div><div class="line">        .addMigrations(MIGRATION_1_2, MIGRATION_2_3).build();</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Migration MIGRATION_1_2 = <span class="keyword">new</span> Migration(<span class="number">1</span>, <span class="number">2</span>) &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">migrate</span><span class="params">(SupportSQLiteDatabase database)</span> </span>&#123;</div><div class="line">        database.execSQL(<span class="string">"CREATE TABLE `Fruit` (`id` INTEGER, "</span></div><div class="line">                + <span class="string">"`name` TEXT, PRIMARY KEY(`id`))"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Migration MIGRATION_2_3 = <span class="keyword">new</span> Migration(<span class="number">2</span>, <span class="number">3</span>) &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">migrate</span><span class="params">(SupportSQLiteDatabase database)</span> </span>&#123;</div><div class="line">        database.execSQL(<span class="string">"ALTER TABLE Book "</span></div><div class="line">                + <span class="string">" ADD COLUMN pub_year INTEGER"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>2）scheme和数据库测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(AndroidJUnit4.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MigrationTest</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEST_DB = <span class="string">"migration-test"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Rule</span></div><div class="line">    <span class="keyword">public</span> MigrationTestHelper helper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MigrationTest</span><span class="params">()</span> </span>&#123;</div><div class="line">        helper = <span class="keyword">new</span> MigrationTestHelper(InstrumentationRegistry.getInstrumentation(),</div><div class="line">                MigrationDb.class.getCanonicalName(),</div><div class="line">                <span class="keyword">new</span> FrameworkSQLiteOpenHelperFactory());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">migrate1To2</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        SupportSQLiteDatabase db = helper.createDatabase(TEST_DB, <span class="number">1</span>);</div><div class="line"></div><div class="line">        <span class="comment">// db has schema version 1. insert some data using SQL queries.</span></div><div class="line">        <span class="comment">// You cannot use DAO classes because they expect the latest schema.</span></div><div class="line">        db.execSQL(...);</div><div class="line"></div><div class="line">        <span class="comment">// Prepare for the next version.</span></div><div class="line">        db.close();</div><div class="line"></div><div class="line">        <span class="comment">// Re-open the database with version 2 and provide</span></div><div class="line">        <span class="comment">// MIGRATION_1_2 as the migration process.</span></div><div class="line">        db = helper.runMigrationsAndValidate(TEST_DB, <span class="number">2</span>, <span class="keyword">true</span>, MIGRATION_1_2);</div><div class="line"></div><div class="line">        <span class="comment">// MigrationTestHelper automatically verifies the schema changes,</span></div><div class="line">        <span class="comment">// but you need to validate that the data was migrated properly.</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3）Understand why Room doesn’t allow object references</p>
<p>Entity之间不允许互相引用（和之前的embedded不同）</p>
<p>应该使用POJO（Plain Old Java Object）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NameTuple</span> </span>&#123;</div><div class="line">    <span class="meta">@ColumnInfo</span>(name=<span class="string">"first_name"</span>)</div><div class="line">    <span class="keyword">public</span> String firstName;</div><div class="line"></div><div class="line">    <span class="meta">@ColumnInfo</span>(name=<span class="string">"last_name"</span>)</div><div class="line">    <span class="keyword">public</span> String lastName;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Dao</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyDao</span> </span>&#123;</div><div class="line">    <span class="meta">@Query</span>(<span class="string">"SELECT first_name, last_name FROM user"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;NameTuple&gt; <span class="title">loadFullName</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ahayoo.com/2017/11/27/初探RoomPersistenceLibrary/" data-id="cjvhe4j6b0012bgd5n3ws5siw" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-通过ADB命令获取当前activity" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/31/通过ADB命令获取当前activity/" class="article-date">
  <time datetime="2017-08-31T02:40:35.000Z" itemprop="datePublished">2017-08-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/通过ADB命令获取当前activity/">通过ADB命令获取当前activity</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>转载，原文链接：<a href="http://blog.csdn.net/youxiansanren/article/details/44220419" target="_blank" rel="external">link</a></p>
<p>自动化测试需要获得当前的activity，来判断处于的页面是否正确；<br><br>hierarchy view经常连不上真机，无法获得activity，所以直接用 adb命令来查看当前运行的 activity就可以；</p>
<h2 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h2><p>1、cmd命令中输入：adb shell 进入shell命令模式</p>
<p>2、shell中输入：logcat | grep ActivityManager   真机运行应用，可以实时 查看当前正在运行的Activity；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">I/ActivityManager(  511): START u0 &#123;act=Android.intent.action.INSERT dat=content</div><div class="line">://com.example.notepad.provider.NotePad/notes cmp=com.example.android.notepad/.N</div><div class="line">oteEditor&#125; from pid 12896</div></pre></td></tr></table></figure></p>
<p>cmp=com.example.android.notepad/.NoteEditor 中， <br><br>com.example.android.notepad 是包名， NoteEditor是当前活动的activity；</p>
<h2 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h2><p>1.cmd命令中输入：adb shell dumpsys activity activities<br>查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">  Main stack:</div><div class="line">  * TaskRecord&#123;42c4e888 #11 A com.example.android.notepad U 0&#125;</div><div class="line">    numActivities=2 rootWasReset=true userId=0</div><div class="line">    affinity=com.example.android.notepad</div><div class="line">    intent=&#123;act=android.intent.action.MAIN cat=[android.intent.category.LAUNCHER</div><div class="line">] flg=0x10200000 cmp=com.example.android.notepad/.NotesList&#125;</div><div class="line">    realActivity=com.example.android.notepad/.NotesList</div><div class="line">    askedCompatMode=false</div><div class="line">    lastThumbnail=android.graphics.Bitmap@42c89cd8 lastDescription=null</div><div class="line">    lastActiveTime=8685859 (inactive for 113s)</div></pre></td></tr></table></figure></p>
<p> cmp=com.example.android.notepad/.NotesList中，<br>com.example.android.notepad 是包名， NotesList是当前活动的activity；</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ahayoo.com/2017/08/31/通过ADB命令获取当前activity/" data-id="cjvhe4j67000wbgd5hras30jc" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-DailyGML-variable-func" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/04/DailyGML-variable-func/" class="article-date">
  <time datetime="2017-08-04T04:46:50.000Z" itemprop="datePublished">2017-08-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GMS2/">GMS2</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/04/DailyGML-variable-func/">DailyGML(8)-variable-func</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本来是照着Reference的顺序，一个接着一个来浏览GML的函数的，但是今天在乱翻文档的过程中，发现GML_Overview这一章，有一个Variable_Functions的部分，发现应该会有作用，于是就中途插进来说一下。</p>
<p>这个系列的方法分为两个部分：global和instance</p>
<ul>
<li>variable_instance_exists</li>
<li>variable_instance_get_names</li>
<li>variable_instance_get</li>
<li>variable_instance_set</li>
<li>variable_global_exists</li>
<li>variable_global_get</li>
<li>variable_global_set</li>
</ul>
<p>global系列用来获取全局变量、设置全局变量</p>
<p>instance系列用来根据instance_id，检查instance中的变量、设置变量、检查变量是否存在、以及获取这个inst中全部变量的名字列表</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ahayoo.com/2017/08/04/DailyGML-variable-func/" data-id="cjvhe4j69000ybgd5nrgcib69" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-DailyGML-http-func" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/01/DailyGML-http-func/" class="article-date">
  <time datetime="2017-08-01T04:33:23.000Z" itemprop="datePublished">2017-08-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GMS2/">GMS2</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/01/DailyGML-http-func/">DailyGML(7)-http-func</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>来看看GML内置的HTTP函数。</p>
<h2 id="http-get-url"><a href="#http-get-url" class="headerlink" title="http_get(url);"></a>http_get(url);</h2><p>arg0 - string : Get请求的URL</p>
<p>return - Real : ？</p>
<p>发送这个请求之后，会异步返回AsyncEvent，返回的结果会保存在一个叫做async_load的map里面：</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>http方法的返回值，用来区分多个http请求的</td>
</tr>
<tr>
<td>status</td>
<td>小于0的为错误，0为completed，1为正在接受数据</td>
</tr>
<tr>
<td>result</td>
<td>返回的数据(string)</td>
</tr>
<tr>
<td>url</td>
<td>之前的request url</td>
</tr>
<tr>
<td>http_status</td>
<td>http status response code</td>
</tr>
<tr>
<td>contentLength</td>
<td>如果status为1，则会包含这个，传输数据的总长度</td>
</tr>
<tr>
<td>sizeDownloaded</td>
<td>如果status为1，则会包含这个，已经下载的数据</td>
</tr>
</tbody>
</table>
<p>example</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">get = http_get(&quot;http://www.MacSweeneyGames.com/logon?username=&quot; + name);</div><div class="line"></div><div class="line">if ds_map_find_value(async_load, &quot;id&quot;) == get</div><div class="line">&#123;</div><div class="line">   if ds_map_find_value(async_load, &quot;status&quot;) == 0</div><div class="line">    &#123;</div><div class="line">        r_str = ds_map_find_value(async_load, &quot;result&quot;);</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        r_str = &quot;null&quot;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="http-get-file-url-local-target"><a href="#http-get-file-url-local-target" class="headerlink" title="http_get_file(url, local_target);"></a>http_get_file(url, local_target);</h2><p>这个和之前的http_get几乎一样，唯一不同的就是多了一个本地目录的设置。使用这个api可以从远端下载文件</p>
<p>直接看例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">file = http_get_file(&quot;http://www.macsweeneygames.com/downloads/upgrade.zip&quot;, &quot;\Downloads\Upgrade.zip&quot;);</div><div class="line">// in Async Event</div><div class="line">if ds_map_find_value(async_load, &quot;id&quot;) == file</div><div class="line">   &#123;</div><div class="line">   var status = ds_map_find_value(async_load, &quot;status&quot;);</div><div class="line">   if status == 0</div><div class="line">      &#123;</div><div class="line">      var path = ds_map_find_value(async_load, &quot;result&quot;);</div><div class="line">      var files = zip_unzip(path, &quot;/NewContent/&quot;);</div><div class="line">      if files &gt; 0</div><div class="line">         &#123;</div><div class="line">         global.ExtraContent = true;</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h2 id="http-post-string-url-string"><a href="#http-post-string-url-string" class="headerlink" title="http_post_string(url, string);"></a>http_post_string(url, string);</h2><p>这个函数用来发送post请求，和之前的func也没有什么区别，第二个参数里面包含的是post需要发送的数据</p>
<p>看例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">var str = &quot;name=&quot; + global.player_name + &quot;&amp;score=&quot; + string(global.player_score);</div><div class="line">post = http_post_string(&quot;http://www.angusgames.com/game?game_id=&quot; + string(global.game_id), str);</div><div class="line"></div><div class="line">// in async event</div><div class="line">var r_str = &quot;null&quot;;</div><div class="line">if ds_map_find_value(async_load, &quot;id&quot;) == post</div><div class="line">&#123;</div><div class="line">    if ds_map_find_value(async_load, &quot;status&quot;) == 0</div><div class="line">    &#123;</div><div class="line">        r_str = ds_map_find_value(async_load, &quot;result&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="http-request-url-method-header-map-body"><a href="#http-request-url-method-header-map-body" class="headerlink" title="http_request(url, method, header_map, body);"></a>http_request(url, method, header_map, body);</h2><p>用的最多的大概是这个了，可以自由配置。</p>
<p>method：: “GET”, “HEAD”, “POST”, “PUT”, “DELETE”, “TRACE”, “OPTIONS”, or “CONNECT”.</p>
<p>header_map ： 需要自己创建一个ds_map</p>
<p>body：string，可以为空。如果是发文件，则需要buffer的handle</p>
<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">var map = ds_map_create();</div><div class="line">ds_map_add(map, &quot;Host&quot;, &quot;225.0.0.97:3000&quot;);</div><div class="line">ds_map_add(map, &quot;Connection&quot;, &quot;keep-alive&quot;);</div><div class="line">ds_map_add(map, &quot;Content-Length&quot;, &quot;169&quot;);</div><div class="line">ds_map_add(map, &quot;Cache-Control&quot;, &quot;max-age=0&quot;);</div><div class="line">ds_map_add(map, &quot;Authorization&quot;, &quot;Basic eW95b19hZG1pbjpjNG5lZmllbGQ=&quot;);</div><div class="line">ds_map_add(map, &quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;);</div><div class="line">ds_map_add(map, &quot;User-Agent&quot;, &quot;Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36&quot;);</div><div class="line">ds_map_add(map, &quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</div><div class="line">ds_map_add(map, &quot;Accept-Encoding&quot;, &quot;gzip,deflate,sdch&quot;);</div><div class="line">ds_map_add(map, &quot;Accept-Language&quot;, &quot;en-GB,en-US;q=0.8,en;q=0.6&quot;);</div><div class="line">ds_map_add(map, &quot;Cookie&quot;, &quot;request_method=GET; _InAppPurchases_session=69bb6ef6eec2b&quot;);</div><div class="line">var data=&quot;utf8=%E2%9C%93&amp;authenticity_token=kPmS14DcYcuKgMFZUsN3XFfj3mhs%3D&amp;product%5Bname%5D=CatchTheHaggis&amp;product%5Bproduct_id%5D=http_test&amp;commit=Create+Product&quot;;</div><div class="line">request = http_request(&quot;http:225.0.0.97:3000/products&quot;, &quot;POST&quot;, map, data);</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ahayoo.com/2017/08/01/DailyGML-http-func/" data-id="cjvhe4j63000rbgd5o8pa9o65" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-DailyGML-get-xxx-async" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/28/DailyGML-get-xxx-async/" class="article-date">
  <time datetime="2017-07-28T04:38:04.000Z" itemprop="datePublished">2017-07-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GMS2/">GMS2</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/28/DailyGML-get-xxx-async/">DailyGML(6)-get-xxx-async</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>从这一篇开始，将会将相近的function放在一起看。</p>
<p>get_integer_async(string, default);</p>
<p>弹出一个非阻塞的Dialog，让用户输入一个数据<br><br>arg0 - string : Dialog的提示信息<br><br>arg1 - real : 默认的数据<br><br>return - real : 获得一个async的msg id</p>
<p>这个方法会返回一个id，用这个id在Asynchronous Dialog event里面，来获取到我们实际填写的信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// call</div><div class="line">msg = get_integer_async(&quot;How old are you?&quot;, 0);</div><div class="line"></div><div class="line">// in event</div><div class="line">var i_d = ds_map_find_value(async_load, &quot;id&quot;);</div><div class="line">if i_d == msg</div><div class="line">   &#123;</div><div class="line">   if ds_map_find_value(async_load, &quot;status&quot;)</div><div class="line">      &#123;</div><div class="line">      global.Age = ds_map_find_value(async_load, &quot;value&quot;);</div><div class="line">      &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>get_login_async(name, password);</p>
<p>这个和integer是类似的，不过这个方法是用来获取两个string类型的字段，分别来代表用户名和密码。</p>
<p>arg0 - string ； 默认用户名<br><br>arg1 - string ： 默认密码<br><br>return - real ： async的msg id</p>
<p>get_string_async(string, default);</p>
<p>这个和integer也是类似的，不过是获取单个string的数据</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ahayoo.com/2017/07/28/DailyGML-get-xxx-async/" data-id="cjvhe4j5x000mbgd5cxa9ovf3" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Catégories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/GMS2/">GMS2</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Mot-clés</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/">Jenkins</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Nuage de mot-clés</h3>
    <div class="widget tagcloud">
      <a href="/tags/Jenkins/" style="font-size: 10px;">Jenkins</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/05/09/Flutter-FutureBuilder/">Flutter-FutureBuilder</a>
          </li>
        
          <li>
            <a href="/2019/03/07/Jenkins读取Properties文件时的编码问题/">Jenkins读取Properties文件时的编码问题</a>
          </li>
        
          <li>
            <a href="/2018/02/22/CertificatePinner与Charles抓包的问题/">证书固定、CertificatePinner与Charles抓包的问题</a>
          </li>
        
          <li>
            <a href="/2018/02/13/GML迷之问题/">GML迷之问题</a>
          </li>
        
          <li>
            <a href="/2018/01/08/LiveData和ViewModel/">Android架构组件（二）——ViewModel和LiveData</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 firzencode<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>